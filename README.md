# SEDåˆ†æAPI - ç”Ÿæ´»éŸ³é›†è¨ˆã‚µãƒ¼ãƒ“ã‚¹

éŸ³éŸ¿ã‚¤ãƒ™ãƒ³ãƒˆæ¤œå‡ºï¼ˆSEDï¼‰ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å„ªå…ˆé †ä½ã«åŸºã¥ã„ã¦ç”Ÿæ´»éŸ³ã‚’æŠ½å‡ºãƒ»é›†è¨ˆã™ã‚‹FastAPIãƒ™ãƒ¼ã‚¹ã®REST APIã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚å¥åº·ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã«é‡è¦ãªç”Ÿä½“åå¿œã‚’å„ªå…ˆçš„ã«è¡¨ç¤ºã—ã€æ—¥å¸¸ç”Ÿæ´»ã®éŸ³ã‚’ä½“ç³»çš„ã«åˆ†é¡ã—ã¾ã™ã€‚

## ğŸš¨ é‡è¦: ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•ã«ã¤ã„ã¦

**ã“ã®APIã¯å®Œå…¨è‡ªå‹•CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚**
- âœ… mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã§è‡ªå‹•çš„ã«æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
- âœ… æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ä¸è¦ï¼ˆGitHub Actions ãŒå…¨ã¦å‡¦ç†ï¼‰
- âš ï¸ è©³ç´°ã¯ [CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³](#cicd-ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³) ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§

## ğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### ğŸŒ ä¸»ãªæ©Ÿèƒ½
- **å„ªå…ˆé †ä½ãƒ™ãƒ¼ã‚¹ã®ç”Ÿæ´»éŸ³æŠ½å‡º**: å¥åº·ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã«é‡è¦ãªç”Ÿä½“åå¿œã‚’æœ€å„ªå…ˆè¡¨ç¤º
- **éŸ³ã®è‡ªå‹•çµ±åˆ**: é¡ä¼¼ã™ã‚‹éŸ³ã‚’è‡ªå‹•çš„ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦ã€ã‚ˆã‚Šå¼·ã„ä¿¡å·ã¨ã—ã¦æ¤œå‡º
- **ãƒã‚¤ã‚ºé™¤å»**: èª¤æ¤œå‡ºã®å¤šã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’è‡ªå‹•é™¤å¤–
- **å®Œå…¨è‡ªå‹•åŒ–**: CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«ã‚ˆã‚‹è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

### ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ
- **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**: Supabase `behavior_yamnet` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆASTéŸ³éŸ¿åˆ†æçµæœï¼‰
- **ãƒ‡ãƒ¼ã‚¿å‡¦ç†**: å„ªå…ˆé †ä½ã«åŸºã¥ãç”Ÿæ´»éŸ³ã®æŠ½å‡ºã¨é›†è¨ˆ
- **ãƒ‡ãƒ¼ã‚¿ä¿å­˜**: Supabase `behavior_summary` ãƒ†ãƒ¼ãƒ–ãƒ«
- **APIæä¾›**: FastAPIã«ã‚ˆã‚‹REST APIï¼ˆè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾å¿œï¼‰

## ğŸ“Š é›†è¨ˆå‡¦ç†ã®ä»•æ§˜

### å‡¦ç†ãƒ•ãƒ­ãƒ¼
1. **ãƒ‡ãƒ¼ã‚¿å–å¾—**: behavior_yamnetãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰æŒ‡å®šdevice_idãƒ»æ—¥ä»˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
2. **ã‚¤ãƒ™ãƒ³ãƒˆæŠ½å‡º**: å„time_blockï¼ˆ30åˆ†ã‚¹ãƒ­ãƒƒãƒˆï¼‰ã®eventsã‹ã‚‰ãƒ©ãƒ™ãƒ«ã‚’æŠ½å‡º  
3. **éŸ³ã®çµ±åˆ**: é¡ä¼¼ã™ã‚‹éŸ³ã‚’è‡ªå‹•çš„ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆæ°´é–¢é€£â†’ã€Œæ°´ã®éŸ³ã€ãªã©ï¼‰
4. **ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**: é™¤å¤–ãƒªã‚¹ãƒˆã«åŸºã¥ã„ã¦ãƒã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆã‚’é™¤å»
5. **å„ªå…ˆé †ä½åˆ¤å®š**: ç”Ÿä½“åå¿œ â†’ å£°ãƒ»ä¼šè©± â†’ ç”Ÿæ´»éŸ³ â†’ ãã®ä»–ã®é †ã§é¸åˆ¥
6. **ç”Ÿæ´»éŸ³ãƒªã‚¹ãƒˆç”Ÿæˆ**: æœ€å¤§10ä»¶ã‚’æŠ½å‡ºï¼ˆç”Ÿä½“åå¿œã¯å¿…ãšå«ã‚ã‚‹ï¼‰
7. **æ—¥æœ¬èªåŒ–**: æœ€å¾Œã«æ—¥æœ¬èªã«ç¿»è¨³ã—ã¦ä¿å­˜

### ãƒ‡ãƒ¼ã‚¿å½¢å¼
- **æ–°å½¢å¼ï¼ˆASTï¼‰**: `{"time": 0.0, "events": [{"label": "Speech", "score": 0.85}, ...]}`
- **æ—§å½¢å¼ï¼ˆYAMNetï¼‰**: `{"label": "Speech", "prob": 0.85}`

## ğŸ¯ ç”Ÿæ´»éŸ³ã®å„ªå…ˆé †ä½ã‚·ã‚¹ãƒ†ãƒ 

### å„ªå…ˆé †ä½ã«åŸºã¥ãè¡¨ç¤º
ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã¯ä»¥ä¸‹ã®å„ªå…ˆé †ä½ã§æœ€å¤§10ä»¶ã®ç”Ÿæ´»éŸ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

1. **ğŸ”´ æœ€å„ªå…ˆ: ç”Ÿä½“åå¿œï¼ˆå¥åº·ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ï¼‰**
   - å’³ã€ãã—ã‚ƒã¿ã€é¼»ã‚’ã™ã™ã‚‹éŸ³ã€å‘¼å¸éŸ³
   - ã„ã³ãã€ãŸã‚æ¯ã€ã—ã‚ƒã£ãã‚Šã€ã’ã£ã·ã€å’€åš¼éŸ³
   - **ç‰¹å¾´**: 1å›ã§ã‚‚æ¤œå‡ºã•ã‚Œã‚Œã°å¿…ãšè¡¨ç¤º

2. **ğŸ—£ï¸ å„ªå…ˆåº¦2: å£°ãƒ»ä¼šè©±ï¼ˆç¤¾ä¼šæ´»å‹•ã®æŒ‡æ¨™ï¼‰**
   - è©±ã—å£°ã€å­ä¾›ã®å£°ã€ä¼šè©±ã€ç¬‘ã„å£°
   - æ³£ãå£°ã€æ­Œå£°ã€é›»è©±ã®éŸ³
   - **ç‰¹å¾´**: å‡ºç¾å›æ•°ã®å¤šã„é †ã«è¡¨ç¤º

3. **ğŸ  å„ªå…ˆåº¦3: ç”Ÿæ´»éŸ³ï¼ˆæ—¥å¸¸æ´»å‹•ï¼‰**
   - æ°´ã®éŸ³ã€é£Ÿå™¨ã®éŸ³ã€ãƒ‰ã‚¢ã€è¶³éŸ³
   - ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã€å®¶é›»ã®éŸ³ï¼ˆãƒ†ãƒ¬ãƒ“ã€æƒé™¤æ©Ÿç­‰ï¼‰
   - **ç‰¹å¾´**: å‡ºç¾å›æ•°ã®å¤šã„é †ã«è¡¨ç¤º

4. **âœ¨ ãã®ä»–**
   - ä¸Šè¨˜ã‚«ãƒ†ã‚´ãƒªå¤–ã®éŸ³ï¼ˆéŸ³æ¥½ãªã©ï¼‰
   - **ç‰¹å¾´**: æ®‹ã‚Šæ ã«å‡ºç¾å›æ•°é †ã§è¡¨ç¤º

## ğŸ”§ éŸ³ã®çµ±åˆãƒãƒƒãƒ”ãƒ³ã‚°

ã‚·ã‚¹ãƒ†ãƒ ã¯é¡ä¼¼ã™ã‚‹éŸ³ã‚’è‡ªå‹•çš„ã«çµ±åˆã—ã¦ã€ã‚ˆã‚Šå¼·ã„ä¿¡å·ã¨ã—ã¦æ¤œå‡ºã—ã¾ã™ï¼š

- **æ°´ã®éŸ³**: è›‡å£ã€ã‚·ãƒ³ã‚¯ã€æ³¨ãéŸ³ã€æ°´æ»´ãªã©æ°´é–¢é€£ã®éŸ³
- **ã‚¿ã‚¤ãƒ”ãƒ³ã‚°**: ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿å…¥åŠ›é–¢é€£ã®éŸ³
- **å‹•ç‰©**: ãƒšãƒƒãƒˆã€å®¶ç•œãªã©å‹•ç‰©é–¢é€£ã®éŸ³
- **è¶³éŸ³**: æ­©è¡Œã€èµ°è¡Œãªã©ç§»å‹•ã«é–¢ã™ã‚‹éŸ³
- **ãƒ‰ã‚¢**: ãƒ‰ã‚¢ãƒ™ãƒ«ã€ãƒãƒƒã‚¯ã€æ–½éŒ éŸ³ãªã©ãƒ‰ã‚¢é–¢é€£ã®éŸ³
- **é£Ÿå™¨ã®éŸ³**: çš¿ã€ã‚«ãƒˆãƒ©ãƒªãƒ¼ã€é£Ÿå™¨ãŒè§¦ã‚Œåˆã†éŸ³
- **å­ä¾›ã®å£°**: å­ä¾›ã®è©±ã—å£°ã€éŠã³å£°ã€å«ã³å£°
- **è©±ã—å£°**: ã‚¹ãƒ”ãƒ¼ãƒã€ä¼šè©±ã€ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãªã©
- **æˆ¸æ£šãƒ»å¼•ãå‡ºã—**: åç´ã®é–‹é–‰éŸ³

## ğŸš« é™¤å¤–ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆ

ä»¥ä¸‹ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯èª¤æ¤œå‡ºã‚„ãƒã‚¤ã‚ºã®ãŸã‚è‡ªå‹•çš„ã«é™¤å¤–ã•ã‚Œã¾ã™ï¼š

```python
EXCLUDED_EVENTS = [
    'Snake',       # ãƒ˜ãƒ“ - é€šå¸¸ã®ç”Ÿæ´»ç’°å¢ƒã§ã¯è€ƒãˆã«ãã„
    'Insect',      # æ˜†è™« - èª¤æ¤œå‡ºãŒå¤šã„
    'Cricket',     # ã‚³ã‚ªãƒ­ã‚® - èª¤æ¤œå‡ºãŒå¤šã„
    'White noise', # ãƒ›ãƒ¯ã‚¤ãƒˆãƒã‚¤ã‚º - ç„¡æ„å‘³ãªç’°å¢ƒãƒã‚¤ã‚º
    'Mains hum',   # é›»æºãƒãƒ éŸ³ - é›»æ°—çš„ãƒã‚¤ã‚ºï¼ˆ50/60Hzï¼‰
    'Mouse',       # ãƒã‚¦ã‚¹ - èª¤æ¤œå‡ºãŒå¤šã„ãƒã‚¤ã‚º
    'Arrow',       # çŸ¢ - æ„å‘³ä¸æ˜ãªã‚¤ãƒ™ãƒ³ãƒˆ
]
```

### é™¤å¤–ã®ä»•çµ„ã¿
- âœ… **ç”Ÿãƒ‡ãƒ¼ã‚¿ä¿å­˜**: behavior_yamnetãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯å…¨ã‚¤ãƒ™ãƒ³ãƒˆãŒä¿å­˜ã•ã‚Œã‚‹
- âŒ **é›†è¨ˆé™¤å¤–**: ç”Ÿæ´»éŸ³ãƒªã‚¹ãƒˆã«ã¯å«ã¾ã‚Œãªã„
- âŒ **è¡¨ç¤ºé™¤å¤–**: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã¯è¡¨ç¤ºã•ã‚Œãªã„

## ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ 

### behavior_yamnet ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼‰
```sql
CREATE TABLE behavior_yamnet (
  device_id     text NOT NULL,
  date          date NOT NULL,
  time_block    text NOT NULL,
  events        jsonb NOT NULL,
  PRIMARY KEY (device_id, date, time_block)
);
```

### behavior_summary ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆé›†è¨ˆçµæœï¼‰
```sql
CREATE TABLE behavior_summary (
  device_id       text NOT NULL,
  date            date NOT NULL,
  summary_ranking jsonb NOT NULL,  -- ç”Ÿæ´»éŸ³ãƒªã‚¹ãƒˆ
  time_blocks     jsonb NOT NULL,  -- æ™‚é–“åˆ¥è©³ç´°
  PRIMARY KEY (device_id, date)
);
```

**summary_rankingï¼ˆç”Ÿæ´»éŸ³ãƒªã‚¹ãƒˆï¼‰ã®æ§‹é€ :**
```json
[
  {"event": "å’³", "count": 2},
  {"event": "è©±ã—å£°", "count": 42},
  {"event": "æ°´ã®éŸ³", "count": 15},
  {"event": "ã‚¿ã‚¤ãƒ”ãƒ³ã‚°", "count": 10},
  {"event": "ãƒ‰ã‚¢", "count": 5}
]
```
ï¼ˆå„ªå…ˆé †ä½ã«åŸºã¥ãæœ€å¤§10ä»¶ã€ç”Ÿä½“åå¿œã¯å¿…ãšå«ã¾ã‚Œã‚‹ï¼‰

## ğŸš€ CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

### ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼ï¼ˆå®Œå…¨è‡ªå‹•åŒ–ï¼‰

```mermaid
graph LR
    A[git push main] --> B[GitHub Actions]
    B --> C[ARM64 Docker Build]
    C --> D[ECR Push]
    D --> E[EC2 Auto Deploy]
    E --> F[Health Check]
```

### é–‹ç™ºè€…ãŒã‚„ã‚‹ã“ã¨

```bash
# 1. ã‚³ãƒ¼ãƒ‰ä¿®æ­£
code sed_aggregator.py

# 2. ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆã“ã‚Œã ã‘ï¼ï¼‰
git add .
git commit -m "feat: æ–°æ©Ÿèƒ½è¿½åŠ "
git push origin main

# 3. è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚’å¾…ã¤ï¼ˆç´„5åˆ†ï¼‰
# GitHub Actions: https://github.com/hey-watchme/api-sed-aggregator/actions
```

## ğŸš¨ CI/CDå°å…¥æ™‚ã®é‡è¦ãªæ³¨æ„ç‚¹ï¼ˆå¿…èª­ï¼‰

### âš ï¸ 2025å¹´9æœˆ27æ—¥ã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã‹ã‚‰å­¦ã‚“ã æ•™è¨“

CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å°å…¥æ™‚ã«ç’°å¢ƒå¤‰æ•°ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã€APIãŒã€ŒInvalid API keyã€ã§å¤±æ•—ã—ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®ç‚¹ã‚’å¿…ãšç¢ºèªã—ã¦ãã ã•ã„ã€‚

### ğŸ“‹ CI/CDå°å…¥ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

#### 1. **ECRãƒªãƒã‚¸ãƒˆãƒªåã®çµ±ä¸€** ğŸ”´ æœ€é‡è¦
```yaml
# âŒ é–“é•ã„ï¼šç•°ãªã‚‹åå‰ã‚’ä½¿ç”¨
# deploy-ecr.sh: watchme-api-behavior-aggregator
# docker-compose.prod.yml: watchme-api-sed-aggregator

# âœ… æ­£è§£ï¼šçµ±ä¸€ã•ã‚ŒãŸåå‰ã‚’ä½¿ç”¨
ECR_REPOSITORY="watchme-api-behavior-aggregator"  # deploy-ecr.sh
image: 754724220380.dkr.ecr.ap-southeast-2.amazonaws.com/watchme-api-behavior-aggregator:latest  # docker-compose.prod.yml
```

**ãªãœå¤±æ•—ã—ãŸã‹**: é–‹ç™ºè€…ãŒECRãƒªãƒã‚¸ãƒˆãƒªåã‚’çµ±ä¸€ã›ãšã€ç•°ãªã‚‹åå‰ã‚’ä½¿ç”¨ã—ãŸãŸã‚ã€æ­£ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒãƒ—ãƒ«ã•ã‚Œãªã‹ã£ãŸã€‚

#### 2. **ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.envï¼‰ã®é…ç½®** ğŸ”´ æœ€é‡è¦
```bash
# EC2ã‚µãƒ¼ãƒãƒ¼ä¸Šã«.envãƒ•ã‚¡ã‚¤ãƒ«ãŒå¿…è¦
/home/ubuntu/api-sed-aggregator/
â”œâ”€â”€ docker-compose.prod.yml
â”œâ”€â”€ .env  # â† ã“ã‚ŒãŒå¿…é ˆï¼
```

**ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«å¿…ãšå®Ÿè¡Œ**:
```bash
# .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’EC2ã«ã‚³ãƒ”ãƒ¼
scp -i ~/watchme-key.pem .env ubuntu@3.24.16.82:/home/ubuntu/api-sed-aggregator/.env
```

**ãªãœå¤±æ•—ã—ãŸã‹**: CI/CDã§Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã¯æ›´æ–°ã•ã‚ŒãŸãŒã€.envãƒ•ã‚¡ã‚¤ãƒ«ãŒEC2ã‚µãƒ¼ãƒãƒ¼ã«é…ç½®ã•ã‚Œã¦ã„ãªã‹ã£ãŸã€‚

#### 3. **docker-compose.prod.ymlã®åŒæœŸ** 
```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ã§å¤‰æ›´ã—ãŸå¾Œã€å¿…ãšEC2ã«ã‚³ãƒ”ãƒ¼
scp -i ~/watchme-key.pem docker-compose.prod.yml ubuntu@3.24.16.82:/home/ubuntu/api-sed-aggregator/
```

**ãªãœå¤±æ•—ã—ãŸã‹**: ãƒ­ãƒ¼ã‚«ãƒ«ã®docker-compose.prod.ymlã¨EC2ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒåŒæœŸã•ã‚Œã¦ã„ãªã‹ã£ãŸã€‚

### ğŸ”§ æ­£ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

#### æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæ¨å¥¨ï¼‰
```bash
# 1. ECRã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ï¼†ãƒ—ãƒƒã‚·ãƒ¥
./deploy-ecr.sh

# 2. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨ç’°å¢ƒå¤‰æ•°ã‚’EC2ã«é…ç½®
./deploy-to-ec2.sh  # ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒ.envã¨docker-compose.prod.ymlã‚’é…ç½®

# 3. å‹•ä½œç¢ºèª
curl -s https://api.hey-watch.me/behavior-aggregator/health | jq '.'
```

#### GitHub Actions CI/CDï¼ˆå°†æ¥å®Ÿè£…æ™‚ã®æ³¨æ„ï¼‰
```yaml
# .github/workflows/deploy.yml ã«å«ã‚ã‚‹ã¹ãé‡è¦ãªã‚¹ãƒ†ãƒƒãƒ—
- name: Deploy to EC2
  run: |
    # 1. .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‹ã‚‰ç”Ÿæˆ
    echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > .env
    echo "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}" >> .env
    
    # 2. EC2ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
    scp .env ubuntu@$EC2_HOST:/path/to/api/
    scp docker-compose.prod.yml ubuntu@$EC2_HOST:/path/to/api/
    
    # 3. ã‚³ãƒ³ãƒ†ãƒŠå†èµ·å‹•
    ssh ubuntu@$EC2_HOST "cd /path/to/api && docker-compose -f docker-compose.prod.yml down && docker-compose -f docker-compose.prod.yml up -d"
```

### ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

#### ç—‡çŠ¶ï¼šã€ŒInvalid API keyã€ã‚¨ãƒ©ãƒ¼
```bash
# 1. ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèª
ssh ubuntu@3.24.16.82 "docker exec api-sed-aggregator env | grep SUPABASE"

# 2. .envãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
ssh ubuntu@3.24.16.82 "ls -la /home/ubuntu/api-sed-aggregator/.env"

# 3. ã‚³ãƒ³ãƒ†ãƒŠãƒ­ã‚°ç¢ºèª
ssh ubuntu@3.24.16.82 "docker logs api-sed-aggregator | tail -50"
```

#### ç—‡çŠ¶ï¼šã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ãªã„
```bash
# æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤
docker stop api-sed-aggregator && docker rm api-sed-aggregator

# æœ€æ–°ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒ«
docker pull 754724220380.dkr.ecr.ap-southeast-2.amazonaws.com/watchme-api-behavior-aggregator:latest

# å†èµ·å‹•
docker-compose -f docker-compose.prod.yml up -d
```

### ğŸ“ ä»–ã®APIã¨ã®æ•´åˆæ€§ç¢ºèª

åŒã˜CI/CDãƒ—ãƒ­ã‚»ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ä»–ã®APIã¨è¨­å®šã‚’æ¯”è¼ƒï¼š
- `/api_gen-prompt_mood-chart_v1` - Vibe Aggregator API
- `/api_emotion-aggregator_v1` - Emotion Aggregator API

ã“ã‚Œã‚‰ã®APIã®`deploy-ecr.sh`ã¨`docker-compose.prod.yml`ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

## ğŸš¢ æœ¬ç•ªç’°å¢ƒæƒ…å ±

- **ã‚µãƒ¼ãƒãƒ¼**: AWS EC2 (3.24.16.82)
- **ECRãƒªãƒã‚¸ãƒˆãƒª**: `754724220380.dkr.ecr.ap-southeast-2.amazonaws.com/watchme-api-behavior-aggregator`
- **ã‚³ãƒ³ãƒ†ãƒŠå**: `api-sed-aggregator`
- **ãƒãƒ¼ãƒˆ**: 8010
- **æœ¬ç•ª API URL**: https://api.hey-watch.me/behavior-aggregator/
- **APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: https://api.hey-watch.me/behavior-aggregator/docs

## ğŸŒ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### 1. åˆ†æé–‹å§‹ `POST /analysis/sed`
**æ©Ÿèƒ½**: ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»é›†è¨ˆãƒ»ä¿å­˜ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ

```bash
POST /analysis/sed
{
  "device_id": "d067d407-cf73-4174-a9c1-d91fb60d64d0",
  "date": "2025-07-07"
}
```

### 2. åˆ†æçŠ¶æ³ç¢ºèª `GET /analysis/sed/{task_id}`
**æ©Ÿèƒ½**: ã‚¿ã‚¹ã‚¯ã®é€²æ—çŠ¶æ³ã¨çµæœã‚’å–å¾—

### 3. å…¨ã‚¿ã‚¹ã‚¯ä¸€è¦§ `GET /analysis/sed`
**æ©Ÿèƒ½**: å®Ÿè¡Œä¸­ãƒ»å®Œäº†æ¸ˆã¿ã®å…¨ã‚¿ã‚¹ã‚¯ã‚’ä¸€è¦§è¡¨ç¤º

### 4. ã‚¿ã‚¹ã‚¯å‰Šé™¤ `DELETE /analysis/sed/{task_id}`
**æ©Ÿèƒ½**: å®Œäº†ãƒ»å¤±æ•—ã—ãŸã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤

### 5. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ `GET /health`
**æ©Ÿèƒ½**: APIç¨¼åƒçŠ¶æ³ã®ç¢ºèª

## ğŸ“‹ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### ç’°å¢ƒå¤‰æ•°è¨­å®š
`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š
```env
SUPABASE_URL=https://qvtlwotzuzbavrzqhyvt.supabase.co
SUPABASE_KEY=your-supabase-key
```

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º
```bash
# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -r requirements.txt

# ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
python api_server.py
```

## ğŸ”§ æŠ€è¡“ä»•æ§˜

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- **åŒæ™‚å‡¦ç†**: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯ã«ã‚ˆã‚‹éåŒæœŸå‡¦ç†
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åŠ¹ç‡**: å˜ä¸€ã‚¯ã‚¨ãƒªã§ã®ä¸€æ‹¬å–å¾—
- **ãƒ¡ãƒ¢ãƒªåŠ¹ç‡**: ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- Supabaseæ¥ç¶šã‚¨ãƒ©ãƒ¼ã®è‡ªå‹•æ¤œå‡º
- ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆã®è‡ªå‹•å‡¦ç†
- è©³ç´°ãªãƒ­ã‚°å‡ºåŠ›

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

**APIä»•æ§˜ã®è©³ç´°**: Swagger UI
- æœ¬ç•ªç’°å¢ƒ: `https://api.hey-watch.me/behavior-aggregator/docs`
- é–‹ç™ºç’°å¢ƒ: `http://localhost:8010/docs`